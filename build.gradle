plugins {
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.0.13'
}

repositories {
    mavenCentral()
    // Repositorio oficial de Jaspersoft para dependencias de JasperReports 7
    maven { url 'https://jaspersoft.jfrog.io/jaspersoft/third-party-ce-artifacts/' }
}

javafx {
    // Actualizado a v23 (compatible con JDK 24) para mayor estabilidad
    version = "23"
    modules = ['javafx.controls', 'javafx.graphics', 'javafx.fxml', 'javafx.web', 'javafx.base', 'javafx.swing', 'javafx.media']
}

dependencies {
    // JavaFX Controls - v11.2.2 es estable, pero para Java 24 usamos la rama compatible
    implementation 'org.controlsfx:controlsfx:11.2.2'

    // PostgreSQL Driver
    implementation 'org.postgresql:postgresql:42.7.2'

    // CalendarFX - Mantenemos la exclusión para evitar conflictos de versiones de JFX
    implementation('com.calendarfx:view:11.12.7') {
        exclude group: 'org.openjfx'
    }

    // JasperReports 7.0.1
    implementation 'net.sf.jasperreports:jasperreports:7.0.1'
    implementation 'net.sf.jasperreports:jasperreports-fonts:7.0.1'
    implementation 'net.sf.jasperreports:jasperreports-functions:7.0.1'
    implementation 'net.sf.jasperreports:jasperreports-chart-themes:7.0.1'
    implementation 'net.sf.jasperreports:jasperreports-pdf:7.0.1'

    // Motor PDF OpenPDF para Jasper 7
    implementation 'com.github.librepdf:openpdf:1.3.30'

    // Logging SLF4J
    implementation 'org.slf4j:slf4j-api:2.0.9'
    implementation 'org.slf4j:slf4j-simple:2.0.9'
}

// Forzar versiones para evitar el error de mezcla de versiones de JFX
configurations.all {
    resolutionStrategy {
        force 'org.openjfx:javafx-base:23'
        force 'org.openjfx:javafx-graphics:23'
        force 'org.openjfx:javafx-controls:23'
        force 'org.openjfx:javafx-fxml:23'
        force 'org.openjfx:javafx-web:23'
        force 'org.openjfx:javafx-swing:23'
        force 'org.openjfx:javafx-media:23'
    }
}

java {
    toolchain {
        // CAMBIO CRÍTICO: Definimos Java 24 como la versión del proyecto
        languageVersion = JavaLanguageVersion.of(24)
    }
}

application {
    mainClass = 'com.javafx.Clases.Launcher'
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}

// Configuración de recursos para asegurar que FXML e imágenes se incluyan en el JAR [cite: 52]
sourceSets {
    main {
        resources {
            srcDirs = ["src/main/resources"]
            includes = ["**/*.fxml", "**/*.png", "**/*.jpg", "**/*.gif",
                        "**/*.properties", "**/*.jasper", "**/*.css", "**/*.jrxml", "**/*.xml"]
        }
    }
}

tasks.register('copyDependencies', Copy) {
    from configurations.runtimeClasspath
    into "$buildDir/libs/lib"
}

tasks.jar {
    dependsOn copyDependencies
    manifest {
        attributes(
                'Main-Class': application.mainClass.get(),
                'Class-Path': configurations.runtimeClasspath.files.collect { "lib/" + it.name }.join(' ')
        )
    }
}

// BLOQUE DE ACCESO NATIVO - Crucial para que JasperReports funcione en Java 24
tasks.withType(JavaExec).configureEach {
    jvmArgs += [
            "--add-opens=java.base/java.lang=ALL-UNNAMED",
            "--add-opens=java.base/java.util=ALL-UNNAMED",
            "--add-opens=java.base/java.lang.reflect=ALL-UNNAMED",
            "--add-opens=java.base/java.text=ALL-UNNAMED",
            "--add-opens=java.desktop/java.awt.font=ALL-UNNAMED",
            "--add-opens=java.desktop/java.awt.geom=ALL-UNNAMED",
            "--add-opens=java.base/java.io=ALL-UNNAMED"
    ]
}